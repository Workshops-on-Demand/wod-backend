#!/bin/bash
#
# Script to be called to setup an appliance needed for a certain workshop
#
# (c) Bruno Cornec <bruno.cornec@hpe.com>, Hewlett Packard Development
# (c) Frederic Passeron <frederic.passeron@hpe.com>, Hewlett Packard Development
#
# Released under the GPLv2 License
## API Call to update determinedAI user  creds on detmaster

set -x

source {{ SCRIPTDIR }}/functions.sh


# Define local variables
echo wid=$wid
APPMIN=`get_range_min $wid`
APPMAX=`get_range_max $wid`
echo stdid=$stdid
echo APPMIN=$APPMIN
echo APPMAX=$APPMAX

# Define local variables
UserName="student$stdid"


## Define the Det Master service endpoint for the Determined AI environment on Ezmeral Runtime STAGING
detMaster="https://determinedai2.hpedev.io"
echo $detMaster

#Login as admin user and get token
token=$(curl -i -s -X 'POST' \
  "${detMaster}/api/v1/auth/login" \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "username": "admin",
  "password": "CloudSystem2022*!"
}' | grep token | awk '{print $1}' | tr -d '\r')
echo $token
MyToken=$(echo $token | cut -d':' -f 2 | cut -d',' -f 1 | tr -d '"') # extract token value and remove trailing quotes
echo $MyToken


## Create student on determined AI Master node using api calls and APPMIN APPMAX

for i in {$APPMIN..$APPMAX}; do
 curl -X 'POST' \
   'https://determinedai2.hpedev.io/api/v1/users' \
   -H 'accept: application/json' \
   -H "Authorization: Bearer $MyToken" \
   -d '{
   "user": {
     "username": "student'$i'",
     "admin": false,
     "active": true
    },
    "password": "DetaidefP@SSWD2022*"
 }' 
done

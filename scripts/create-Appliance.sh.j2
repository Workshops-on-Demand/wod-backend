#!/bin/bash

set -x

### copy ssh keys on the stackstorm server
TMPDIR=/tmp/sk.$$
sudo mkdir -p $TMPDIR
sudo cp {{ STDDIR }}/student$stdid/.ssh/id_rsa.pub $TMPDIR
sudo chown -R $USER $TMPDIR
ssh $RTARGET mkdir -p $TMPDIR
scp $TMPDIR/id_rsa.pub $RTARGET:$TMPDIR/
HOMEDIR=`ssh $RTARGET getent passwd student$stdid | cut -d: -f6`
if [ _"$HOMEDIR" != _"" ]; then
	ssh $RTARGET "echo student$stdid:$randompw | sudo chpasswd"
	if [ _"$w" = _"WKSHP-StackStorm101" ]; then
		# That Workshop also need another passwd reset
		ssh $RTARGET "echo $randompw | sudo htpasswd -i /etc/st2/htpasswd student$stdid"
	fi
	ssh $RTARGET sudo install -d -m 0700 -o student$stdid $HOMEDIR/.ssh
	ssh $RTARGET sudo install -m 0600 -o student$stdid $TMPDIR/id_rsa.pub $HOMEDIR/.ssh/authorized_keys
	EXITVAL=0
else
	echo "student$stdid doesn't exist on the appliance $RTARGET"
	EXITVAL=-1
fi

## check staging or prod
ssh $RTARGET rm -rf $TMPDIR
rm -rf $TMPDIR
exit $EXITVAL

#!/bin/bash

set -x

source {{ SCRIPTDIR }}/functions.sh

export RTARGET={{ hostvars[inventory_hostname]['IP-WKSHP-Dataspaces'] }}
export NAME=dataspaceslab
export TMPDIR=/tmp/$NAME.$stdid.ret
dataspacesport3=$(({{ hostvars[inventory_hostname]['DATASPACESPORT3-WKSHP-Dataspaces'] }}))

env
{{ SCRIPTDIR }}/cleanup-container-ratio.sh

mkdir -p $TMPDIR
# Delete user on dscp-project container
cat > $TMPDIR/unregister_user << EOF
#!/bin/bash
curl -X POST -H "Content-Type: application/json" --data '{"email":"student$stdid@hpedev.io"}' --location  http://$RTARGET:$dataspacesport3/project/v1alpha1/remove_user/
EOF
ssh -q {{ NOCHECKSSH }} $RTARGET mkdir -p $TMPDIR
scp -q {{ NOCHECKSSH }} $TMPDIR/unregister_user ${RTARGET}:$TMPDIR
ssh -q {{ NOCHECKSSH }} $RTARGET chmod 755 $TMPDIR/unregister_user
ssh -q {{ NOCHECKSSH }} $RTARGET $TMPDIR/unregister_user
ssh -q {{ NOCHECKSSH }} $RTARGET sudo rm -rf $TMPDIR

sudo rm -rf $TMPDIR

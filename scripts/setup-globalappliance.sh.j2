#!/bin/bash

#set -x

source /etc/wod.sh
source {{ WODSCRIPTDIR }}/functions.sh

# Do we need LDAP setup or not
if [ _"`get_ldap_status $wid`" != _"false" ]; then
	echo "This is a setup with LDAP"
	WODLDAPSETUP=1
else
	WODLDAPSETUP=0
fi

echo "Use ansible to setup generic remote appliance at $WODRTARGET"
ansible-playbook {{ WODANSIBLEDIR }}/setup_appliance.yml -i $WODRTARGET, -e "WODRTARGET=$WODRTARGET WORKSHOP=$w WODAPPMIN=$WODAPPMIN WODAPPMAX=$WODAPPMAX WODLDAPSETUP=$WODLDAPSETUP WODLDAPDMN={{ WODLDAPDMN }} WODLDAPSRVNAME={{ WODLDAPSRVNAME }}" $WODANSPLAYOPT $WODANSPRIVOPT
if [ -f "{{ WODANSIBLEDIR }}/setup_${w}_appliance.yml" ]; then
	echo "Use ansible to setup specificities for $w on remote appliance $WODRTARGET"
	ansible-playbook {{ WODANSIBLEDIR }}/setup_${w}_appliance.yml -i $WODRTARGET, -e "WODRTARGET=$WODRTARGET WORKSHOP=$w WODAPPMIN=$WODAPPMIN WODAPPMAX=$WODAPPMAX WODLDAPSETUP=$WODLDAPSETUP WODLDAPDMN={{ WODLDAPDMN }} WODLDAPSRVNAME={{ WODLDAPSRVNAME }}" $WODANSPLAYOPT $WODANSPRIVOPT
fi

echo "Final script setup phase for $w on remote appliance $WODRTARGET"
exit 0

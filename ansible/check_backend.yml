---
- name: Playbook to check periodically WoD backend
  hosts: all
  gather_facts: true
  tasks:
    - name: Ensure that this a compliant WoD system
      ansible.builtin.include_tasks: "{{ WODINSANSDIR }}/check_system.yml"

    - name: Setup backend ufw firewall TCP rules
      become: true
      become_user: root
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
        state: enabled
      with_items:
        - "{{ WODBEPORT }}"
        - "{{ WODPOSTPORT }}"
      when:
        - ansible_facts['distribution'] == "Ubuntu"
        - ansible_facts['distribution_major_version'] >= "20"

    - name: Setup backend firewalld TCP rules
      become: true
      become_user: root
      ansible.posix.firewalld:
        port: "{{ item }}/tcp"
        permanent: true
        state: enabled
      with_items:
        - "{{ WODBEPORT }}"
        - "{{ WODPOSTPORT }}"
      when:
        - ansible_facts['distribution'] == "CentOS"
        - ansible_facts['distribution_major_version'] >= "7"

    - name: If needed create directory "{{ JPHUB }}"
      become: true
      become_user: root
      ansible.builtin.file:
        path: "{{ JPHUB }}"
        state: directory
        owner: "{{ WODUSER }}"
        group: "{{ WODUSER }}"
        mode: "0751"

    - name: Ensure existence of directory etc/jupyterhub under "{{ JPHUB }}"
      ansible.builtin.file:
        path: "{{ JPHUB }}/etc/jupyterhub"
        state: directory
        owner: "{{ WODUSER }}"
        group: "{{ WODUSER }}"
        mode: "0751"

    - name: Ensure listening port in postfix master.cf is configured correctly
      become: true
      become_user: root
      ansible.builtin.lineinfile:
        path: /etc/postfix/master.cf
        regex: ^smtp\s*inet
        line: "{{ WODPOSTPORT }}      inet  n       -       y       -       -       smtpd"
        state: present

    - name: Ensure myhostname in postfix main.cf is configured correctly
      become: true
      become_user: root
      ansible.builtin.lineinfile:
        path: /etc/postfix/main.cf
        regex: ^myhostname =
        line: myhostname = {{ WODBEEXTFQDN }}
        state: present

    - name: Ensure listening addresses in postfix main.cf is configured correctly
      become: true
      become_user: root
      ansible.builtin.lineinfile:
        path: /etc/postfix/main.cf
        regex: ^inet_interfaces =
        line: inet_interfaces =  {{ WODBEFQDN }},localhost
        state: present

    - name: Ensure the mailbox command is correct
      become: true
      become_user: root
      ansible.builtin.lineinfile:
        path: /etc/postfix/main.cf
        regex: ^[#]*mailbox_command =
        line: mailbox_command = /usr/bin/procmail -a "$EXTENSION"
        state: present

    - name: Ensure mydestination in postfix main.cf is configured correctly
      become: true
      become_user: root
      ansible.builtin.lineinfile:
        path: /etc/postfix/main.cf
        regex: ^mydestination =
        line: mydestination = $myhostname, {{ WODBEFQDN }}, localhost, localhost.localdomain
        state: present

    - name: Ensure hostname is not modified (useful for vagrant setup e.g.)
      become: true
      become_user: root
      ansible.builtin.lineinfile:
        path: /etc/postfix/main.cf
        regex: ^append_dot_mydomain =
        line: append_dot_mydomain = no
        state: present

    - name: Deploy an instanciated procmailrc conf file
      ansible.builtin.template:
        src: "{{ WODSYSDIR }}/procmailrc.j2"
        dest: "{{ ansible_env.HOME }}/.procmailrc"
        mode: "0600"

    - name: Enable postfix service
      become: true
      become_user: root
      ansible.builtin.systemd:
        state: restarted
        daemon_reload: true
        enabled: true
        name: postfix

    - name: Setup crontab for daily check of template in dev user home dir
      become: true
      become_user: root
      ansible.builtin.cron:
        name: wod-check-template
        minute: "{{ 59 | random(seed=inventory_hostname) }} "
        hour: "05"
        user: root
        job: /usr/local/bin/wod-check-template
        cron_file: wod-check-template
        state: present

    # If you name compiled script shc with one of the following prefix, it will be expanded by deliver
    # If you name it with a get-... prefix, it won't and thus will be templated by compile_scripts later at WoD delivery time
    # Works for both private and public parts
    - name: Deliver create/reset/setup scripts as ansible template for variable expansion
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "{{ item | dirname }}/{{ item | basename | regex_replace('.j2$') }}"
        mode: "0755"
      with_fileglob: ['{{ WODSCRIPTDIR }}/*.sh*.j2', '{{ WODSCRIPTPRIVDIR }}/*.sh*.j2']

    - name: Deliver variables files as ansible template for variable expansion
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "{{ item | dirname }}/{{ item | basename | regex_replace('.j2$') }}"
        mode: "0644"
      with_fileglob: ['{{ WODANSIBLEDIR }}/{{ WODGROUP }}/*.yml.j2', '{{ WODANSIBLEPRIVDIR }}/{{ WODGROUP }}/*.yml.j2']

    - name: "Ensure existence of directory {{ WODSTUDDIR }}"
      become: true
      become_user: root
      ansible.builtin.file:
        path: "{{ WODSTUDDIR }}"
        state: directory
        owner: "{{ WODUSER }}"
        group: "{{ WODUSER }}"
        mode: "0711"

    - name: Lockdown /home
      become: true
      become_user: root
      ansible.builtin.file:
        path: /home
        state: directory
        owner: root
        group: root
        mode: "0711"

    - name: "Ensure existence of directory .mail under {{ ansible_env.HOME }}"
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.mail"
        state: directory
        owner: "{{ WODUSER }}"
        group: "{{ WODUSER }}"
        mode: "0750"

    - name: "Ensure that file vault_secret exists in {{ WODANSIBLEPRIVDIR }}"
      ansible.builtin.lineinfile:
        path: "{{ WODANSIBLEPRIVDIR }}/vault_secret"
        regexp: ^.*$
        line: "{{ VAULTPWD }}"

    - name: "Fix modes for vault_secret under {{ WODANSIBLEPRIVDIR }}"
      ansible.builtin.file:
        path: "{{ WODANSIBLEPRIVDIR }}/vault_secret"
        mode: "0600"

    - name: Ensure that required nbconvert directories exists
      become: true
      become_user: root
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ WODUSER }}"
        group: "{{ WODUSER }}"
        mode: "0755"
      with_items:
        - /usr/local/share/jupyter/nbconvert/
        - /usr/local/share/jupyter/nbconvert/templates/
        - /usr/local/share/jupyter/nbconvert/templates/html/
        - /usr/local/share/jupyter/nbconvert/templates/latex/
        - "{{ JPHUB }}/share/jupyter/nbconvert/templates/html/"

    # Perform private part before users management to allow interruption of the deliver script
    # during normal operations - waiting till end of users management can take hours for 2000 users.
    # Potential impact: private scripts are run before users creation, so may miss some part of setup.
    - name: Test private tasks YAML file
      ansible.builtin.command: ls "{{ WODANSIBLEPRIVDIR }}/check_backend.yml"
      register: acj_path
      failed_when: false
      changed_when: false

    - name: Now call private tasks if available
      ansible.builtin.include_tasks: "{{ WODANSIBLEPRIVDIR }}/check_backend.yml"
      when:
        - acj_path.rc == 0

    - name: Copy WoD service file as ansible template for variable expansion
      become: true
      become_user: root
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/etc/systemd/system/{{ item | basename | regex_replace('.j2$') }}"
        mode: "0644"
      with_fileglob: ['{{ WODSYSDIR }}//jupyterhub.service.j2', '{{ WODSYSPRIVDIR }}//jupyterhub.service.j2']

    # Done after private part, which may affect branding
    - name: Enable backend WoD services
      become: true
      become_user: root
      ansible.builtin.systemd:
        state: restarted
        daemon_reload: true
        enabled: true
        name: "{{ item }}"
      with_items:
        - jupyterhub

    # Users management
    - name: Remove existing jupyterhub users
      ansible.builtin.command:
        cmd: "curl -X DELETE --silent {{ WODCURLOPT }} -H 'Authorization: token {{ WODBETOKEN }}' {{ WODBEAPIURL }}/hub/api/users/{{ 'student%s' | format(item) }}"
        warn: false
      loop: "{{ range(WODUSERMIN, WODUSERMAX + 1) | list }}"
      when: CLEAN | bool
      register: result
      changed_when: result.rc != 0

    - name: Remove Linux users and their home directory
      become: true
      become_user: root
      ansible.builtin.user:
        name: "{{ 'student%s' | format(item) }}"
        state: absent
        remove: true
        force: true
      loop: "{{ range(WODUSERMIN, WODUSERMAX + 1) | list }}"
      when: CLEAN | bool

    - name: Ensure dedicated students groups exist
      become: true
      become_user: root
      ansible.builtin.group:
        name: "{{ 'student%s' | format(item) }}"
        state: present
        gid: "{{ item + GIDBASE }}"
      loop: "{{ range(WODUSERMIN, WODUSERMAX + 1) | list }}"

    - name: Ensure Linux students users exists with their home dir
      become: true
      become_user: root
      ansible.builtin.user:
        name: "{{ 'student%s' | format(item) }}"
        state: present
        create_home: true
        home: "{{ WODSTUDDIR }}/{{ 'student%s' | format(item) }}"
        comment: "{{ 'student%s' | format(item) }}"
        shell: /bin/bash
        uid: "{{ item + UIDBASE }}"
        group: "{{ 'student%s' | format(item) }}"
      loop: "{{ range(WODUSERMIN, WODUSERMAX + 1) | list }}"

    - name: Ensure jupyterhub students users exist
      ansible.builtin.uri:
        url: "{{ WODBEAPIURL }}/hub/api/users/{{ 'student%s' | format(item) }}"
        headers:
          Authorization: token {{ WODBETOKEN }}
        method: POST
        status_code:
          - 201
          - 409
      loop: "{{ range(WODUSERMIN, WODUSERMAX + 1) | list }}"

    - name: Setup ACL for students with the account {{ WODUSER }}
      become: true
      become_user: root
      ansible.posix.acl:
        path: "{{ WODSTUDDIR }}/{{ 'student%s' | format(item) }}"
        recursive: true
        entity: "{{ WODUSER }}"
        etype: user
        permissions: rwx
        state: present
        recalculate_mask: mask
      loop: "{{ range(WODUSERMIN, WODUSERMAX + 1) | list }}"

    - name: Setup default ACL for students with account "{{ WODUSER }}"
      become: true
      become_user: root
      ansible.posix.acl:
        path: "{{ WODSTUDDIR }}/{{ 'student%s' | format(item) }}"
        recursive: true
        entity: "{{ WODUSER }}"
        etype: user
        permissions: rwx
        default: true
        state: present
        recalculate_mask: mask
      loop: "{{ range(WODUSERMIN, WODUSERMAX + 1) | list }}"

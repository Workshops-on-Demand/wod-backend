- hosts: all
  tasks:
    - name: Script Compilation Issue
      fail:
        msg: COMPILE variable is empty ! Fat fingers ?!?
      when: COMPILE is not defined

    - name: Create list of files to compile
      set_fact:
        cmpfiles: "{{ COMPILE.split(',') }}"
      when: COMPILE | length > 0

    - name: Print the cmpfiles var
      debug:
        var: cmpfiles

    - name: Compile shc scripts in place
      command: "shc -f {{ SCRIPTDIRECTORY }}/{{ item }}"
      with_items: "{{ cmpfiles }}"
      when: COMPILE | length > 0

    - name: Deliver compiled shc scripts
      become: yes
      become_user: root
      copy:
        src: "{{ item }}"
        dest: "{{ item | regex_replace(SCRIPTDIRECTORY, STUDDIR + '/student' + STDID) }}"
        owner: student{{ STDID }}
        group: student{{ STDID }}
        mode: 0700
      with_fileglob: "{{ SCRIPTDIRECTORY }}/*.shc.x"
      when: COMPILE | length > 0

    - name: setup ACL for the scripts
      become: yes
      become_user: root
      ansible.posix.acl:
        path: "{{ item | regex_replace(SCRIPTDIRECTORY, STUDDIR + '/student' + STDID) }}"
        recursive: no
        entity: "{{ WODUSER }}"
        etype: user
        permissions: rwx
        state: present
      with_fileglob: "{{ SCRIPTDIRECTORY }}/*.shc.x"
      when: COMPILE | length > 0

    - name: Remove shc scripts in place
      command: "rm -f {{ SCRIPTDIRECTORY }}/{{ item }}.c.x {{ SCRIPTDIRECTORY }}/{{ item }}.x"
      with_items: "{{ cmpfiles }}"
      when: COMPILE | length > 0
